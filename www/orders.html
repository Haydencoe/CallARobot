$def with (params, text)
$var title: CallARobot - Orders
$var jsfiles: 
$var params: $:params




<script>
    function leave_state(user, s) {
        var id = '#btn-' + user;
        $$(id).removeAttr('onclick');
        $$(id).prop('disabled', true);
        $$(id).html("");
        $$(id).removeClass('btn-success btn-danger btn-warning btn-default btn-primary');
        switch(s) {
            case 'CALLED':
            case 'INIT':
            default:
                break;
        }

    }

    function enter_state(user, s) {
        var id = '#btn-' + user;
        console.log(user+" "+id);
        $$(id).prop('disabled', false);
        switch(s) {
            case 'CALLED':
                $$(id).html("$:text('Accept')");
                $$(id).attr(
                    'onClick',
                    "send({'method':'set_state', state: 'ACCEPT','user': \""+user+"\"});"
                );
                $$(id).addClass('btn-success');
                break;
            case 'ACCEPT':
                $$(id).html("$:text('click when arrived')");
                $$(id).attr(
                    'onClick',
                    "send({'method':'set_state', state: 'ARRIVED','user': \""+user+"\"});"
                );
                $$(id).addClass('btn-warning');
                break;
            case 'ARRIVED':
                $$(id).html("$:text('Arrived at picker.')");                
                break;
            case 'LOADED':
                $$(id).html("$:text('Loaded. Click and return robot')");
                $$(id).attr(
                    'onClick',
                    "send({'method':'set_state', state: 'INIT','user': \""+user+"\"});"
                );
                $$(id).addClass('btn-warning');
                break;
            case 'INIT':
            default:
                $$(id).html("$text('idle')");
                $$(id).prop('disabled', true);
        }

    }

    function transition(user, new_state) {
        if (states[user] == undefined || new_state != states[user]) {
            console.log('old state: ' + states[user]);
            leave_state(user, states[user]);
            states[user] = new_state;
            enter_state(user, states[user]);        
            console.log('new state: ' + states[user]);
        }
    }

    function _update_orders(data) {
        new_states = data['states'];
        console.log('update orders');
        for(var key in new_states) {
            transition(key, new_states[key]);
            $$('#state-' + key).html(new_states[key]);
        }
    }

    function _set_state(s) {
    }

    function get_states(){
        send({
            'method':'get_states'
        });
    }

    function register() {
        send({
            'method':'register'
        });
        console.log("registered!");
    }

    document.onready = function() {
        webnsock_init();
        socket.onopen = function () {
          console.log("Connected!");
          register()
          get_states();
        };
    }

    states = {};

</script>

<div class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div  class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">$text('Orders')</h3>
                    </div>
                    
                    <div class="panel-body">
                        <table class="table table-condensed table-striped">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>State</th>
                                    <th>Action</th>
                                    <th></th>
                                </tr>
                            </thead>


                            <tbody>
                                $for u in params['users']:
                                    <tr>
                                        <td class="col-xs-2">$u</td>
                                        <td class="col-xs-2">
                                            <p id="state-$u"></p>
                                        </td>
                                        <td class="col-xs-7">
                                            <div class="btn-group2" role="group">
                                                <button 
                                                    id="btn-$u" 
                                                    class="btn btn-block">
                                                </button>
                                            </div>
                                        </td>
                                        <td class="col-xs-1">
                                            <div class="btn-group2" role="group">
                                                <button 
                                                    class="btn btn-sm btn-danger"
                                                    onclick="send({
                                                        'method':'set_state', 
                                                        'state': 'INIT',
                                                        'user': '$u'});">
                                                    reset
                                                </button>
                                            </div>
                                        </td>

                                    </tr>
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- <div class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Robot Status</h3>
                    </div>
                    <div class="panel-body">
                        <table class="table table-condensed table-striped">
                            <tbody>
                                <tr>
                                    <td class="col-md-3">$text('Assigned')</td>
                                    <td class="col-md-9"><p id="assigned_robot"></p></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
 -->
